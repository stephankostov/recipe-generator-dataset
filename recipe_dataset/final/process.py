# AUTOGENERATED! DO NOT EDIT! File to edit: ../../notebooks/10-final-db-process.ipynb.

# %% auto 0
__all__ = ['root', 'special_tokens', 'temp_remap', 'shift_food_ids', 'process_food_ids', 'remove_duplicate_ids',
           'compile_recipe_food_ids']

# %% ../../notebooks/10-final-db-process.ipynb 3
from pyprojroot import here
root = here()
import sys
sys.path.append(str(root))

# %% ../../notebooks/10-final-db-process.ipynb 4
import pandas as pd
import numpy as np

from tqdm import tqdm
tqdm.pandas()

from ..utils.parallel import parallel_apply


# %% ../../notebooks/10-final-db-process.ipynb 6
special_tokens = ['pad', 'mask', 'unknown', 'end']

# %% ../../notebooks/10-final-db-process.ipynb 13
temp_remap = {
    143: 142,
    150: 149,
    262: 261,
    1064: 1063
}

# %% ../../notebooks/10-final-db-process.ipynb 44
def shift_food_ids(food_ids, special_tokens):
    shift = len(special_tokens)
    return food_ids.progress_apply(lambda id: id + shift if pd.notna(id) else id)

# %% ../../notebooks/10-final-db-process.ipynb 48
def process_food_ids(food_ids, special_tokens):
    food_ids['food_id'] = shift_food_ids(food_ids['food_id'], special_tokens)
    food_ids['food_id'] = food_ids['food_id'].map(temp_remap)
    food_ids = food_ids.fillna(special_tokens.index('unknown'))
    return food_ids

# %% ../../notebooks/10-final-db-process.ipynb 52
def remove_duplicate_ids(recipe, max_length):
    base = pd.Series(pd.NA, index=range(0,max_length), dtype='Int64')
    recipe_clone = recipe.copy(deep=True)
    recipe_clone[recipe_clone.duplicated()] = pd.NA
    recipe_clone = recipe_clone.dropna().reset_index(drop=True)
    base = base.fillna(recipe_clone)
    return base

# %% ../../notebooks/10-final-db-process.ipynb 58
def compile_recipe_food_ids(food_ids, special_tokens):

    print('Compiling recipe food ids')
    recipe_food_ids = pd.DataFrame(food_ids.groupby('recipe')['food_id'].progress_aggregate(list).tolist()).loc[:,:25]

    print('Removing duplicates')
    recipe_food_ids = parallel_apply(recipe_food_ids,
               remove_duplicate_ids,
               args=(17,),
               meta=pd.DataFrame(dtype="Int64", columns=range(0,17)),
               npartitions=1000)

    print('Formatting')
    recipe_food_ids = recipe_food_ids \
        .fillna(special_tokens.index('pad')) \
        .astype('int') \
        .to_numpy()

    return recipe_food_ids
