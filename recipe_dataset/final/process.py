# AUTOGENERATED! DO NOT EDIT! File to edit: ../../notebooks/10-final-db-process.ipynb.

# %% auto 0
__all__ = ['root', 'special_tokens', 'temp_remap', 'remove_salt', 'shift_food_ids', 'process_foods_df', 'merge_duplicates']

# %% ../../notebooks/10-final-db-process.ipynb 3
from pyprojroot import here
root = here()
import sys
sys.path.append(str(root))

# %% ../../notebooks/10-final-db-process.ipynb 4
import pandas as pd
import numpy as np

from tqdm import tqdm
tqdm.pandas()

from ..utils.parallel import parallel_apply


# %% ../../notebooks/10-final-db-process.ipynb 5
pd.options.mode.chained_assignment = None  # default='warn'

# %% ../../notebooks/10-final-db-process.ipynb 7
special_tokens = ['pad', 'mask', 'unknown', 'start', 'end']

# %% ../../notebooks/10-final-db-process.ipynb 14
temp_remap = {
    143: 142,
    150: 149,
    262: 261,
    1064: 1063
}

# %% ../../notebooks/10-final-db-process.ipynb 50
def remove_salt(foods, food_names):
    return foods[~(foods['food_id']==np.where(food_names=='salt')[0][0])]

# %% ../../notebooks/10-final-db-process.ipynb 53
def shift_food_ids(food_ids, special_tokens):
    shift = len(special_tokens)
    return food_ids.progress_apply(lambda id: id + shift if pd.notna(id) else id)

# %% ../../notebooks/10-final-db-process.ipynb 58
def process_foods_df(foods, food_names, special_tokens):
    foods['food_id'] = shift_food_ids(foods['food_id'], special_tokens)
    foods = remove_salt(foods, food_names)
    # food_ids = food_ids.replace(temp_remap)
    foods['food_id'] = foods['food_id'].fillna(special_tokens.index('unknown'))
    return foods

# %% ../../notebooks/10-final-db-process.ipynb 65
def merge_duplicates(recipe):
    return recipe.groupby('food_id')['weight_ratio'].sum()
