# AUTOGENERATED! DO NOT EDIT! File to edit: ../../notebooks/04-density-db-food-match.ipynb.

# %% auto 0
__all__ = ['root', 'col_types', 'split_types', 'sort_order', 'fuzzy_search', 'transform_ingredient',
           'match_food_df_on_ingredient', 'calculate_match_stats', 'select_from_matches', 'match_ingredient',
           'create_na_synonyms_df']

# %% ../../notebooks/04-density-db-food-match.ipynb 5
from pyprojroot import here
root = here()
import sys
sys.path.append(str(root))

# %% ../../notebooks/04-density-db-food-match.ipynb 6
import pandas as pd
import numpy as np
import seaborn as sns

from pyprojroot import here
root = here()

from ..utils.join_utils import *

import nltk
from nltk.corpus import wordnet
import spacy
from spacy.matcher import Matcher
from spacy.util import filter_spans

from thefuzz import fuzz

from sentence_transformers import SentenceTransformer
from sentence_transformers.util import cos_sim
import torch
from sklearn.metrics.pairwise import cosine_similarity

import re
import json
import pickle
from itertools import groupby

from tqdm import tqdm
tqdm.pandas()

from ..utils.utils import *

# %% ../../notebooks/04-density-db-food-match.ipynb 10
col_types = ['name.name', 'name.description']
split_types = ['nouns', 'others']

# %% ../../notebooks/04-density-db-food-match.ipynb 19
def fuzzy_search(food_df_description, search_word, threshold=90):

    if not search_word:
        return False
    
    # check if full word match of the *words in string*
    if contains_whole_word(food_df_description, search_word):
        return True

    # check levenstain distance of the *string*
    fuzzy_score = fuzz.ratio(food_df_description, search_word)
    if fuzzy_score >= threshold:
        return True
    
    return False

# %% ../../notebooks/04-density-db-food-match.ipynb 25
with open(f'{root}/data/globals/density/ingredient_transforms.json', 'r') as f:
    default_transforms = json.load(f)

# %% ../../notebooks/04-density-db-food-match.ipynb 26
def transform_ingredient(ingredient):
    ingredient = ingredient[ingredient.notnull()]
    for defualt_instance in default_transforms.values():
        matches = [key_word in ingredient.values for key_word in defualt_instance['key']]
        if all(matches):
            if len(matches) == len(ingredient.index[ingredient.index.str.startswith('name.name.nouns')]): # only match if there are no additional ingredient name nouns
                transformed = pd.Series(defualt_instance['value'], dtype='string', name=ingredient.name)
                transformed = pd.concat([transformed, ingredient[~ingredient.index.str.startswith('name.name.nouns')]])
                transformed = transformed[transformed.notnull()]
                return transformed
    return ingredient

# %% ../../notebooks/04-density-db-food-match.ipynb 37
def match_food_df_on_ingredient(ingredient, exploded_food_df, debug=False):

    ingredient = ingredient[ingredient.notnull()]

    matched_food_df = exploded_food_df.copy(deep=True)
    matched_idxs = []

    debug_idxs = {col: {} for col in ingredient.index}

    for search_col, search_word in ingredient.items():
            
            current_match_idxs = list((matched_food_df.index[matched_food_df['description'].apply(fuzzy_search, args=(search_word,))]).unique())
            debug_idxs[search_col] = {'value': search_word, 'size': len(current_match_idxs), 'idxs': {'fuzzy': current_match_idxs, 'current': current_match_idxs}}

            if current_match_idxs: matched_idxs.extend(current_match_idxs)  
            if matched_idxs: matched_food_df = matched_food_df.loc[matched_idxs]
            debug_idxs[search_col]['idxs']['selected'] = matched_idxs

    matched_idxs = list(set(matched_idxs))
    
    if debug:
        return matched_idxs, debug_idxs
    else:
        return matched_idxs

# %% ../../notebooks/04-density-db-food-match.ipynb 42
with open(f'{root}/data/globals/default_words.json', 'r') as f:
    default_words = json.load(f)['density']

with open(f'{root}/data/globals/exclusion_words.json', 'r') as f:
    exclusion_words = json.load(f)['density']

def calculate_match_stats(food_descriptions, ingredient_values):

    ingredient_noun_values, ingredient_other_values = ingredient_values[:2]
    ingredient_description_values = [*ingredient_values[2], *ingredient_values[3]]

    ingredient_match_position = 99
    description_match_position = 99
    description_match_word_count = 99
    ingredient_nouns_match_count = 0
    ingredient_nouns_whole_match_count = 0
    ingredient_others_match_count = 0
    ingredient_others_whole_match_count = 0
    ingredient_description_match_count = 0
    default_word_count = 0
    exclusion_word_count = 0
    remaining_word_count = 99

    for description_idx, food_description in enumerate(food_descriptions):

        noun_matches = [(ingredient_idx, ingredient_noun_value) for ingredient_idx, ingredient_noun_value in enumerate(ingredient_noun_values)
                if fuzzy_search(food_description, ingredient_noun_value)]
        if noun_matches:
            if description_match_position == 99: 
                description_match_position = description_idx - default_word_count # not including default words in description eg. spice, cinammon.
                description_match_word_count = len(food_description.split(' '))
            if ingredient_match_position == 99: ingredient_match_position = noun_matches[0][0]
            ingredient_noun_values = [value for i, value in enumerate(ingredient_noun_values) if i not in list(zip(*noun_matches))[0]]
        ingredient_nouns_match_count += len(noun_matches)
        ingredient_nouns_whole_match_count += len([noun_match for noun_match in noun_matches if contains_whole_word(food_description, noun_match[1])])

        description_matches = [(ingredient_idx, ingredient_description_value) for ingredient_idx, ingredient_description_value in enumerate(ingredient_description_values)
                if fuzzy_search(food_description, ingredient_description_value)]
        ingredient_description_match_count += len(description_matches)

        other_matches = [(ingredient_idx, ingredient_other_value) for ingredient_idx, ingredient_other_value in enumerate(ingredient_other_values)
                if fuzzy_search(food_description, ingredient_other_value)]
        ingredient_others_match_count += len(other_matches)
        ingredient_others_whole_match_count += len([other_match for other_match in other_matches if contains_whole_word(food_description, other_match[1])])
        if other_matches: 
            ingredient_other_values = [value for i, value in enumerate(ingredient_other_values) if i not in list(zip(*other_matches))[0]] # removing so it can't match twice
        default_word_count += len([default_word for default_word in default_words if contains_whole_word(food_description, default_word)])
        exclusion_word_count += len([exclusion_word for exclusion_word in exclusion_words if contains_whole_word(food_description, exclusion_word)])


    remaining_word_count = np.sum([len(food_description.split(" ")) for food_description in food_descriptions]) + len(ingredient_other_values) - default_word_count - ingredient_nouns_whole_match_count - ingredient_others_match_count 

    return (
        ingredient_match_position,
        description_match_position,
        description_match_word_count,
        ingredient_nouns_match_count,
        ingredient_nouns_whole_match_count,
        ingredient_others_match_count,
        ingredient_others_whole_match_count,
        ingredient_description_match_count,
        default_word_count,
        exclusion_word_count,
        remaining_word_count
    )

# %% ../../notebooks/04-density-db-food-match.ipynb 44
def select_from_matches(match_df, ingredient, sort_order, return_df=False):
    
    ingredient_names = []
    for name_type in ['name', 'description']:
        for word_type in ['nouns', 'others']:
            name_cols = [col for col in ingredient.index[ingredient.notnull()] if col.startswith(f'name.{name_type}.{word_type}')]
            name_cols.reverse()
            ingredient_names.append(ingredient[name_cols].values)

    match_df['ingredient_match_position'], \
    match_df['description_match_position'],\
    match_df['description_match_word_count'],\
    match_df['ingredient_nouns_match_count'],\
    match_df['ingredient_nouns_whole_match_count'],\
    match_df['ingredient_others_match_count'],\
    match_df['ingredient_others_whole_match_count'],\
    match_df['ingredient_description_match_count'],\
    match_df['default_word_count'],\
    match_df['exclusion_word_count'],\
    match_df['description_remaining_word_count'] = zip(*match_df['description_list'].apply(calculate_match_stats, args=(ingredient_names, )))
    
    # ordering dataset by priority
    sort_order = list(zip(*sort_order.items()))
    match_df = match_df.sort_values(
        by=list(sort_order[0]), ascending=list(sort_order[1])
    )

    if return_df:
        result = match_df.reindex(columns=['description_list', *list(sort_order[0])])
    else:
        result = match_df.iloc[0].name if not match_df.empty else pd.NA

    return result

# %% ../../notebooks/04-density-db-food-match.ipynb 45
sort_order = {
    'ingredient_nouns_whole_match_count': False,
    'ingredient_nouns_match_count': False,
    'exclusion_word_count': True,
    'description_match_position': True,
    'ingredient_match_position': True,
    'description_match_word_count': True,
    'ingredient_others_whole_match_count': False,
    'ingredient_others_match_count': False,
    'ingredient_description_match_count': False,
    'default_word_count': False,
    'description_remaining_word_count': True,
    'description_list_length': True,
    'data_type': True
}

# %% ../../notebooks/04-density-db-food-match.ipynb 49
def match_ingredient(ingredient, food_df, exploded_food_df):

    unit_type = ingredient['unit_type']
    if unit_type == 'weight': return pd.NA
    ingredient = ingredient.drop('unit_type')
    local_sort_order = {f'{unit_type}_exists': False, **sort_order}

    ingredient = transform_ingredient(ingredient)

    searched_df = food_df.loc[match_food_df_on_ingredient(ingredient, exploded_food_df)]
    if searched_df.empty: return pd.NA

    selected_food_idx = select_from_matches(searched_df, ingredient, local_sort_order)
    
    return selected_food_idx

# %% ../../notebooks/04-density-db-food-match.ipynb 70
def create_na_synonyms_df(na_expanded_ingredients_df):

    na_synonyms_df = na_expanded_ingredients_df.copy(deep=True)

    for col in na_synonyms_df.columns:
        na_synonyms_df[col] = na_synonyms_df[col].apply(find_alt_words)

    na_synonyms_df = na_synonyms_df.map(lambda x: [] if not isinstance(x, list) else x)

    for col in na_synonyms_df.columns:
        expanded = pd.DataFrame(na_synonyms_df[col].tolist(), index=na_synonyms_df.index)
        expanded.columns = [col + '.' + str(c) for c in expanded.columns]
        na_synonyms_df = na_synonyms_df.join(expanded)
        na_synonyms_df.drop(columns=[col], inplace=True)

    return na_synonyms_df
